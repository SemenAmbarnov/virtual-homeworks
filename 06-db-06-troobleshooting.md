# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

Решение:

- Сначала необходимо найти запрос на который жалуется пользователь. Для этого использую команду:

db.currentOp({ "active" : true, "secs_running" : { "$gt" : 180 }})

Итогом будет выведенный ответ в котором будет содержаться PID процесса.

Далее удаляем его:

db.killOp(номер PID)

- Прочитал про несколько методов:
1. Использование параметра maxTimeMS() при запросах CRUD
2. Использования приведённой выше команды db.currentOp чтобы отслеживать медленные запросы
3. Или использовать настроенный профайлер для мониторинга медленных запросов. Для этого мы используем функцию db.setProfilingLevel() со значением 1 или 2. Значение 1 означает отслеживание медленных запросов, значение 2 отслеживание всех запросов и поэтому данное значение нежелательно, т.к будет влиять на производительность БД. Далее анализировать их с помощью explain и принять меры по их устранению в зависимости от результатов.


## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?


Решение: Интересная задача. В данном случае скорее всего по вводным данным идёт речь об истекающем объёме памяти, так называемым параметром maxmemory. 
А переполнилась она вероятнее всего из за проблем единомементного удаления ключей. Т.е говоря простым языком в БД скопилось очень много старых ключей которые должны единовременного удалиться, но ещё не сделали этого. После их удаления БД разгрузиться и работа нормализуется. И из за этого Redis блокирует операции записи. На redis.io данная проблема описывается как "задержка вызванная истечением срока действия" и для удаления используется 2 способа,т.к называемы lazy way и active way. В превом случае ключи удаляются по проверки истечения срока, но в таком случаем как раз может скопиться множество просроченных ключей. Во втором случае цикл истечения запускается каждые 100 миллисекунд и очищает истёкшие ключи. Надеюсь я правильно понял этот момент.

